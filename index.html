<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Kuş Kaçış – Mobil HTML5 Oyun</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0b0f19">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link rel="icon" href="./icons/icon-192.png">
<style>
  html,body{margin:0;height:100%;background:#0b0f19;color:#eaf2ff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{background:linear-gradient(#3a6ff0,#7fd8ff);touch-action:none}
  #ui{position:fixed;top:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;pointer-events:none}
  .pill{background:rgba(0,0,0,.35);backdrop-filter:blur(6px);color:#fff;border-radius:999px;padding:.25rem .6rem;font-weight:700}
  #msg{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;}
  #msg .card{background:rgba(0,0,0,.55);backdrop-filter:blur(8px);color:#fff;border-radius:16px;padding:18px 20px;text-align:center;max-width:min(92vw,520px)}
  #msg h1{margin:.2rem 0 0;font-size:1.25rem}
  #msg p{margin:.25rem 0 .5rem;opacity:.9}
  #msg .btn{display:inline-block;margin-top:.25rem;background:#18c964;color:#03120a;font-weight:800;border-radius:12px;padding:.6rem 1rem}
  #msg small{display:block;opacity:.8;margin-top:.35rem}
</style>
</head>
<body>
<div id="wrap"><canvas id="game" width="480" height="800" aria-label="Kuş oyunu"></canvas></div>
<div id="ui">
  <span class="pill" id="score">0</span>
  <span class="pill" id="best">En İyi: 0</span>
</div>
<div id="msg" hidden>
  <div class="card">
    <h1 id="title">Kuş Kaçış</h1>
    <p id="subtitle">Ekrana dokun veya Space tuşuna bas. Kuş yükselir, bırakınca alçalır. Engellere çarpma.</p>
    <a class="btn" id="start">Başlat</a>
    <small>Tek dokunuş veya Space tuşu • Mobil uyumlu</small>
  </div>
</div>
<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const msg = document.getElementById('msg');
  const startBtn = document.getElementById('start');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  function fit() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  window.addEventListener('resize', fit, {passive:true});
  fit();

  let running = false;
  let over = false;
  let tPrev = 0;
  let score = 0;
  let best = Number(localStorage.getItem('bird_best') || 0);
  bestEl.textContent = 'En İyi: ' + best;

  const G = 1600;
  const LIFT = -900;
  const MAX_VY = 900;
  const BIRD = { x: 0, y: 0, r: 16, vy: 0 };
  const PIPES = [];
  const GAP_MIN = 140;
  const GAP_MAX = 200;
  const PIPE_W = 64;
  const PIPE_SPACING = 1.7;
  const SPEED = 220;
  let spawnTimer = 0;
  let touching = false;

  function reset() {
    score = 0;
    scoreEl.textContent = '0';
    PIPES.length = 0;
    spawnTimer = 0;
    BIRD.x = Math.max(40, canvas.width / DPR * 0.22);
    BIRD.y = canvas.height / DPR * 0.5;
    BIRD.vy = 0;
    over = false;
  }

  function spawnPipe() {
    const H = canvas.height / DPR;
    const gap = rand(GAP_MIN, GAP_MAX);
    const margin = 40;
    const topHeight = rand(margin, H - margin - gap);
    const bottomY = topHeight + gap;
    PIPES.push({ x: canvas.width / DPR + PIPE_W, top: topHeight, bottom: bottomY, w: PIPE_W, passed:false });
  }

  function rand(a,b){return Math.random()*(b-a)+a}

  function update(dt) {
    const ay = G * dt * (touching ? 0.35 : 1);
    if (touching) {
      BIRD.vy += LIFT * dt;
    }
    BIRD.vy += ay;
    BIRD.vy = Math.max(-MAX_VY, Math.min(MAX_VY, BIRD.vy));
    BIRD.y += BIRD.vy * dt;

    const H = canvas.height / DPR;
    if (BIRD.y < BIRD.r) { BIRD.y = BIRD.r; BIRD.vy = 0; }
    if (BIRD.y > H - BIRD.r) { BIRD.y = H - BIRD.r; over = true; }

    spawnTimer -= dt;
    if (spawnTimer <= 0) { spawnPipe(); spawnTimer = PIPE_SPACING; }

    for (let i=PIPES.length-1;i>=0;i--) {
      const p = PIPES[i];
      p.x -= SPEED * dt;
      if (!p.passed && p.x + p.w < BIRD.x - BIRD.r) {
        p.passed = true; score++; scoreEl.textContent = String(score);
      }
      if (p.x + p.w < -10) PIPES.splice(i,1);
      if (circleRectCollide(BIRD.x, BIRD.y, BIRD.r, p.x, 0, p.w, p.top) ||
          circleRectCollide(BIRD.x, BIRD.y, BIRD.r, p.x, p.bottom, p.w, H - p.bottom)) {
        over = true;
      }
    }
  }

  function circleRectCollide(cx, cy, r, rx, ry, rw, rh){
    const nx = Math.max(rx, Math.min(cx, rx+rw));
    const ny = Math.max(ry, Math.min(cy, ry+rh));
    const dx = cx - nx, dy = cy - ny;
    return dx*dx + dy*dy <= r*r;
  }

  function draw() {
    const W = canvas.width / DPR, H = canvas.height / DPR;
    ctx.clearRect(0,0,W,H);

    ctx.fillStyle = '#2f9e44';
    ctx.fillRect(0, H-80, W, 80);

    for (const p of PIPES) {
      ctx.fillStyle = '#1e293b';
      ctx.fillRect(p.x, 0, p.w, p.top);
      ctx.fillRect(p.x, p.bottom, p.w, H - p.bottom);
      ctx.fillStyle = '#334155';
      ctx.fillRect(p.x, p.top-10, p.w, 10);
      ctx.fillRect(p.x, p.bottom, p.w, 10);
    }

    drawBird(BIRD.x, BIRD.y, BIRD.r, touching);
    ctx.fillStyle = '#174e25';
    ctx.fillRect(0, H-80, W, 6);
  }

  function drawBird(x,y,r,flap) {
    ctx.save();
    ctx.translate(x,y);
    const tilt = Math.max(-0.7, Math.min(0.7, BIRD.vy/500));
    ctx.rotate(tilt);
    ctx.fillStyle = '#ffd43b';
    ctx.beginPath();
    ctx.ellipse(0,0,r*1.2,r,.0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#fab005';
    const wf = flap ? 1.0 : 0.0;
    ctx.beginPath();
    ctx.ellipse(-4, 2 - 6*wf, r*.7, r*.5, .2, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.arc(r*0.6, -r*0.2, r*0.18, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(r*0.62, -r*0.22, r*0.08, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#ff6b6b';
    ctx.beginPath();
    ctx.moveTo(r*1.2, 0);
    ctx.lineTo(r*1.6, r*0.1);
    ctx.lineTo(r*1.2, r*0.2);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function loop(t) {
    if (!running) return;
    const now = t/1000;
    const dt = Math.min(0.032, now - tPrev || 0.016);
    tPrev = now;

    update(dt);
    draw();

    if (over) {
      running = false;
      if (score > best) { best = score; localStorage.setItem('bird_best', String(best)); }
      bestEl.textContent = 'En İyi: ' + best;
      showMsg('Oyun Bitti', 'Skor: ' + score + ' • Devam için dokun veya Space');
      return;
    }
    requestAnimationFrame(loop);
  }

  function showMsg(title, subtitle){
    document.getElementById('title').textContent = title;
    document.getElementById('subtitle').textContent = subtitle;
    msg.hidden = false;
    msg.style.display = 'flex';
  }
  function hideMsg(){
    msg.hidden = true;
    msg.style.display = 'none';
  }

  function start() {
    reset();
    hideMsg();
    running = true;
    tPrev = 0;
    requestAnimationFrame(loop);
  }

  const onDown = (e) => { touching = true; e.preventDefault(); };
  const onUp = (e) => { touching = false; if (!running) { hideMsg(); start(); } };
  canvas.addEventListener('pointerdown', onDown);
  canvas.addEventListener('pointerup', onUp);
  canvas.addEventListener('pointercancel', onUp);
  canvas.addEventListener('pointerleave', (e)=>{ touching=false;});

  startBtn.addEventListener('click', () => { hideMsg(); start(); });

  // Space tuşu ile kontrol
  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
      e.preventDefault();
      if (!running) {
        hideMsg();
        start();
      }
      BIRD.vy = LIFT * 0.5;
    }
  });

  showMsg('Kuş Kaçış', 'Ekrana dokun veya Space tuşuna bas. Kuş yükselir, bırakınca alçalır. Engellere çarpma.');
  // Service worker kaydı (PWA)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', {scope: './'})
        .catch(err => console.error('SW register fail', err));
    });
  }
})();
</script>
</body>
</html>
